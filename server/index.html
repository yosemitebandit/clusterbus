<!doctype html>
<html lang="en">
  <head>
    <link href='css/bootstrap.min.css' rel='stylesheet' />
    <link href='css/bootstrap-responsive.min.css' rel='stylesheet' />
    <link href='css/demo.css' rel='stylesheet' />
  </head>

  <body>
    <div class='container'>

      <ul class='nav nav-pills'>
        <li class='active'>
          <a href='#'>clusterbus !</a>
        </li>
        <li class='pull-right'>
          <a href='#'>api</a>
        </li>
        <li class='pull-right'>
          <a href='#'>about</a>
        </li>
      </ul>

      <div id='maps' class='row show-grid'>
        <div class='span4'>
          <div class='map' id='map-one'>
          </div>
        </div>

        <div class='span4'>
          <div class='map' id='map-two'>
          </div>
        </div>

        <div class='span4'>
          <div class='map' id='map-three'>
          </div>
        </div>
      </div>

      <div id='map-labels' class='row'>
        <div class='span4'>
          <p>Rush hour &ndash; weekdays, 7am-10am and 4pm-6pm</p>
        </div>

        <div class='span4'>
          <p>The calm &ndash; 11pm-3pm on weekdays</p>
        </div>

        <div class='span4'>
          <p>Find me in the club &ndash; Friday and Saturday, 10pm-1am</p>
        </div>
      </div>

      <!--
      <h4>Line metrics &ndash; the <span id='route-container' class='label label-success'>22</span> line</h4>
      -->

      <div id='data-table-container'>
        <h4>Highest variances by stop</h4>
        <table id='data-table' class='table table-hover'>
          <thead>
            <tr>
              <th>Line</th>
              <th>Stop</th>
              <th>Expected frequency (minutes)</th>
              <th>Headway index</th>
              <th>Percent tolerable headway</th>
              <th>Headway standard deviation (minutes)</th>
            </tr>
          </thead>

          <tbody>
          </tbody>
        </table>
      </div>

      <script id='stop-row-template' type='text/x-handlebars-template'>
        <tr>
          <td>{{route}}</td>
          <td>{{stop_name}}</td>
          <td>{{expected_frequency.value}}</td>
          <td>{{headway_index.value}}</td>
          <td>{{percent_tolerable_headway.value}}%</td>
          <td>{{std_dev_headway.value}}</td>
        </tr>
      </script>


      <div class='row'>
        <div class='span12'>
          <p class='hattery muted pull-right'>built in a hurry at <a href="http://hattery.com/reroute/" target=_blank>reroute<span class='bump-down'>/</span>sf</a></p>
        </div>
      </div>
    </div>

    <script src='js/jquery.min.js'></script>
    <script src='http://maps.google.com/maps/api/js?sensor=true'></script>
    <script src='js/gmaps.js'></script>
    <script src='js/handlebars-1.0.rc.1.js'></script>
    <script>

      var source = $('#stop-row-template').html();
      var stop_row_template = Handlebars.compile(source);

      function populate_table(data) {
        // kill the spinner..

        // for each stop
        var rows = ''
        $.each(data.stop_stats, function(index, value) {
          // inject the line name into this data structure
          value.route = data.route;
          // create a row and append
          rows += stop_row_template(value);
        });

        console.log(rows);

        $('#data-table > tbody').append(rows);

      };

      $(function() {

        /* populate the table
        */
        var endpoint = 'http://cluster-bus.appspot.com/api';
        var req = $.ajax({
          url: endpoint
          , dataType: 'jsonp'
          , data: null
          , success: function(data) {
            populate_table(data);
          }
        });

        /* initiate the maps
        */
        var sf = [37.778313, -122.44957, 11];
        var map_one = map_factory('#map-one', sf);
        var map_two = map_factory('#map-two', sf);
        var map_three = map_factory('#map-three', sf);
        // mm..global
        maps = [map_one, map_two, map_three];
      });


      /* synching all map controls
      */
      function update_zoom(zoom) {
        for (i in maps) {
          if (maps[i].map.zoom != zoom) maps[i].map.setZoom(zoom);
        }
      }

      function update_center(center) {
        for (i in maps) {
          if (maps[i].map.center != center) maps[i].map.panTo(center);
        }
      }


      /* the cartographer
      */
      function map_factory(div, loc) {
        return new GMaps({
          div: div
          , lat: loc[0]
          , lng: loc[1]
          , zoom: loc[2]
          , panControl: false
          , zoomControl: false
          , streetViewControl: false
          , mapTypeControl: false
          , scaleControl: false

          , center_changed: function() {
            update_center(this.center);
          }
          , zoom_changed: function() {
            update_zoom(this.zoom);
          }
        });
      }

    </script>
  </body>
</html>
