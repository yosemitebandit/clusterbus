<!doctype html>
<html lang="en">
  <head>
    <link href='css/bootstrap.min.css' rel='stylesheet' />
    <link href='css/bootstrap-responsive.min.css' rel='stylesheet' />
    <link href='css/demo.css' rel='stylesheet' />
  </head>

  <body>
    <div class='container'>

      <ul class='nav nav-pills'>
        <li class='active'>
          <a href='#'>clusterbus !</a>
        </li>
        <li class='pull-right'>
          <a href='#'>api</a>
        </li>
        <li class='pull-right'>
          <a href='#'>about</a>
        </li>
      </ul>

      <div id='maps' class='row show-grid'>
        <div class='span4'>
          <div class='map' id='map-one'>
          </div>
        </div>

        <div class='span4'>
          <div class='map' id='map-two'>
          </div>
        </div>

        <div class='span4'>
          <div class='map' id='map-three'>
          </div>
        </div>
      </div>

      <div id='map-labels' class='row'>
        <div class='span4'>
          <p>Rush hour &ndash; weekdays, 7am-10am and 4pm-6pm</p>
        </div>

        <div class='span4'>
          <p>The calm &ndash; 11pm-3pm on weekdays</p>
        </div>

        <div class='span4'>
          <p>Find me in the club &ndash; Friday and Saturday, 10pm-1am</p>
        </div>
      </div>

      <!--
      <h4>Line metrics &ndash; the <span id='route-container' class='label label-success'>22</span> line</h4>
      -->

      <div id='data-table-container'>
        <h4>Highest variances by stop</h4>
        <table id='data-table' class='table table-hover'>
          <thead>
            <tr>
              <th>Line</th>
              <th>Stop</th>
              <th>Expected frequency (minutes)</th>
              <th>Headway index</th>
              <th>Percent tolerable headway</th>
              <th>Headway standard deviation (minutes)</th>
            </tr>
          </thead>

          <tbody>
          </tbody>
        </table>
      </div>

      <script id='stop-row-template' type='text/x-handlebars-template'>
        <tr>
          <td>{{route}}</td>
          <td>{{stop_name}}</td>
          <td>{{expected_frequency.value}}</td>
          <td>{{headway_index.value}}</td>
          <td>{{percent_tolerable_headway.value}}%</td>
          <td>{{std_dev_headway.value}}</td>
        </tr>
      </script>

      <script id='aggregate-row-template' type='text/x-handlebars-template'>
        <tr>
          <td>{{route}}</td>
          <td><span class='label label-success'>All stops</span></td>
          <td>{{expected_frequency.value}}</td>
          <td>{{headway_index.value}}</td>
          <td>{{percent_tolerable_headway.value}}%</td>
          <td>{{std_dev_headway.value}}</td>
        </tr>
      </script>


      <div class='row'>
        <div class='span12'>
          <p class='hattery muted pull-right'>built in a hurry at <a href="http://hattery.com/reroute/" target=_blank>reroute<span class='bump-down'>/</span>sf</a></p>
        </div>
      </div>
    </div>

    <script src='js/jquery.min.js'></script>
    <script src='http://maps.google.com/maps/api/js?sensor=true'></script>
    <script src='js/gmaps.js'></script>
    <script src='js/handlebars-1.0.rc.1.js'></script>
    <script src='js/underscore-min.js'></script>
    <script>

      var all_stops = [];

      var stop_source = $('#stop-row-template').html();
      var stop_row_template = Handlebars.compile(stop_source);

      var aggregate_source = $('#aggregate-row-template').html();
      var aggregate_row_template = Handlebars.compile(aggregate_source);

      function populate_table(data) {
        // kill the spinner..

        var rows = '';

        // inject the route
        data.route_aggregate['route'] = data.route;
        // save the route aggregate
        rows += aggregate_row_template(data.route_aggregate);

        $.each(data.stop_stats, function(index, value) {
          // inject the line name into this data structure
          value.route = data.route;
          // create a row and append
          rows += stop_row_template(value);
        });

        // append to table
        $('#data-table > tbody').append(rows);
      };


      function populate_map(map, data) {
        // hardcoded scale
        var max_headway = 2;
        var min_headway = 0;

        $.each(data.stop_stats, function(index, value) {
          var marker = new google.maps.Marker({
            position: new google.maps.LatLng(value.lat, value.lon)
            , icon: {
              path: google.maps.SymbolPath.CIRCLE
              , fillOpacity: 0.2
              , fillColor: 'ff0000'
              , strokeOpacity: 1.0
              , strokeColor: 'ff000'
              , strokeWeight: 1.0
              , scale: 10*(value.headway_index.value - min_headway) / (max_headway - min_headway)
            }
            , map: map.map
          });
        });
      };


      function extend_results(data) {
        $.each(data.stop_stats, function(index, value) {
          all_stops.push(value);
        });
      };


      $(function() {
        /* initiate the maps
        */
        // start and end times for each map
        var am_rush = ['2012-10-11T06:30:00', '2012-10-11T09:30:00']
        var midday = ['2012-10-11T09:30:00', '2012-10-11T16:30:00']
        // not quite weekend..
        var weekend = ['2012-10-13T06:00:00', '2012-10-13T19:00:00']

        var sf = [37.778313, -122.44957, 11];
        var map_one = map_factory('#map-one', sf);
        var map_two = map_factory('#map-two', sf);
        var map_three = map_factory('#map-three', sf);
        // mm..global
        maps = [[map_one, am_rush]
          , [map_two, midday]
          , [map_three, weekend]
        ];

        /* populate the maps
        pool all the stop_stats responses
        */
        var endpoint = 'http://cluster-bus.appspot.com/api';
        // flip json/jsonp !!
        //var endpoint = 'data.json';

        for (var i in maps) {
          var req = $.ajax({
            url: endpoint
            // flip back to jsonp
            , dataType: 'jsonp'
            , data: {
              start: maps[i][1][0]
              , end: maps[i][1][1]
            }
            , success: function(data) {
              extend_results(data);

              populate_table(data);


              for (var i in maps) {
                console.log(data.start);
                if (data.start == maps[i][1][0] && data.end == maps[i][1][1]) {
                  populate_map(maps[i][0], data);
                }
              }

            }
          });
        }

      });


      /* synching all map controls
      */
      function update_zoom(zoom) {
        for (i in maps) {
          if (maps[i][0].map.zoom != zoom) maps[i][0].map.setZoom(zoom);
        }
      }

      function update_center(center) {
        for (i in maps) {
          if (maps[i][0].map.center != center) maps[i][0].map.panTo(center);
        }
      }


      /* the cartographer
      */
      function map_factory(div, loc) {
        return new GMaps({
          div: div
          , lat: loc[0]
          , lng: loc[1]
          , zoom: loc[2]
          , panControl: false
          , zoomControl: false
          , streetViewControl: false
          , mapTypeControl: false
          , scaleControl: false

          , center_changed: function() {
            update_center(this.center);
          }
          , zoom_changed: function() {
            update_zoom(this.zoom);
          }
        });
      }

    </script>
  </body>
</html>
